name: e2e-pr

on:
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout with enough history
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50

      # 2️⃣ Install dependencies
      - name: Install dependencies
        run: npm i

      # 3️⃣ Build the app
      - name: Build app
        run: npm run build

      - name: Start server
        run: npm run preview &

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:4173

      # 4️⃣ Install Playwright browsers
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # 5️⃣ Detect changed .vue files in the PR
      - name: Get changed Vue files
        id: changed
        run: |
          git fetch origin main --depth=50
          CHANGED=$(git diff origin/main...HEAD | grep '\.vue$' || true)
          echo "CHANGED_VUE=$CHANGED" >> $GITHUB_OUTPUT

      # 6️⃣ Skip if no vue changes
      - name: Skip if no Vue changes
        if: steps.changed.outputs.CHANGED_VUE == ''
        run: echo "No Vue changes → skipping tests"

      # 7️⃣ Run only relevant tests
      - name: Run Playwright tests for changed components
        if: steps.changed.outputs.CHANGED_VUE != ''
        env:
          CHANGED_VUE: ${{ steps.changed.outputs.CHANGED_VUE }}
        run: |
          for file in $CHANGED_VUE; do
            # Extract just the filename (basename) to match describe block
            component=$(basename $file)
            echo "Running tests for component: $component"
            npx playwright test --grep "$component"
          done
